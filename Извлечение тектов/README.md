# Система извлечения текста из PDF-каталогов косметики

Система для извлечения, очистки и структурирования текста из PDF-каталогов косметики с максимальной дословностью.

## Структура проекта

```
.
├── extractor.py          # Модуль извлечения raw текста из PDF
├── cleaner.py            # Модуль очистки от артефактов верстки
├── assembler.py          # Модуль сборки в логические блоки
├── qc.py                 # Модуль контроля качества
├── main.py               # Главный скрипт обработки
├── visual_control.py     # Скрипт визуального контроля
├── requirements.txt      # Зависимости
└── README.md            # Документация
```

## Установка

1. Установите зависимости:
```bash
pip install -r requirements.txt
```

## Использование

### Основная обработка

Обработка PDF-каталога через все этапы:

```bash
python main.py <путь_к_pdf> [output_dir]
```

Пример:
```bash
python main.py "01 Skinessentials БАЗОВЫЙ УХОД.pdf"
python main.py "каталог.pdf" output
```

### Визуальный контроль

Просмотр результатов каждого этапа:

```bash
# Показать все этапы
python visual_control.py output

# Показать конкретный этап
python visual_control.py output stage1  # Raw текст
python visual_control.py output stage2  # Очищенный текст
python visual_control.py output stage3  # Собранные блоки
python visual_control.py output final   # Финальный результат
python visual_control.py output qc      # Отчет QC
```

### Отдельные модули

Каждый модуль можно запустить отдельно:

```bash
# Извлечение
python extractor.py <pdf_file> [output_dir]

# Очистка
python cleaner.py <raw_text.json> [output_dir]

# Сборка
python assembler.py <cleaned_text.json> [output_dir]

# Контроль качества
python qc.py <raw_text.json> <cleaned.txt> [output_dir]
```

## Этапы обработки

### 1. Extractor (Извлечение)
- Извлекает raw текст из PDF по страницам
- Использует PyMuPDF (fitz) с fallback на pdfplumber
- Сохраняет результаты в `output/stage1_extracted/`

### 2. Cleaner (Очистка)
- Удаляет номера страниц
- Удаляет повторяющиеся заголовки/футеры
- Склеивает переносы слов (гидро- лизованный → гидролизованный)
- Склеивает строки внутри предложений
- Сохраняет результаты в `output/stage2_cleaned/`

### 3. Assembler (Сборка)
- Собирает текст в логические блоки продуктов
- Объединяет карточки продуктов, разбитые на колонки/страницы
- Сохраняет результаты в `output/stage3_assembled/`

### 4. QC (Контроль качества)
- Проверяет полноту извлечения по якорям:
  - Артикулы (Артикул \d+)
  - Названия продуктов (Русское название / english name)
  - pH значения
  - Подзаголовки блоков
- Генерирует отчет `output/qc_report.txt`

## Выходные файлы

После обработки в директории `output/` создаются:

- `cleaned.txt` - финальный очищенный и структурированный текст
- `qc_report.txt` - отчет контроля качества
- `stage1_extracted/` - raw текст по страницам
- `stage2_cleaned/` - очищенный текст по страницам
- `stage3_assembled/` - собранные блоки

## Принципы работы

1. **Максимальная дословность**: никаких пересказов, сокращений или "улучшений"
2. **Детерминированность**: все модули работают по правилам, без LLM
3. **Визуальный контроль**: каждый этап можно проверить отдельно
4. **Контроль качества**: автоматическая проверка полноты извлечения

## Критерии продукта

Блок продукта должен содержать:
- Заголовок вида "Русское название / english name"
- Подзаголовок "Для ..."
- Подзаголовки (Основные активные ингредиенты, Механизм действия, Использование..., Основные преимущества)
- Артикул(ы) и объёмы ("Домашняя линия/Профессиональный объём")

## Устранение проблем

Если в `qc_report.txt` обнаружены отсутствующие якоря:
1. Проверьте соответствующие страницы в `stage1_extracted/raw_pages/`
2. Улучшите правила в `cleaner.py` или `assembler.py`
3. НЕ сокращайте текст - только переизвлеките/пересоберите проблемные страницы

